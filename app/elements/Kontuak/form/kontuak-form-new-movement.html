<link rel="import" href="../../aitgud/form/input/aitgud-generated-uuid.html">
<link rel="import" href="../../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../../../bower_components/paper-input/paper-input-error.html">

<dom-module id="kontuak-form-new-movement">

    <style>
        #errorMessage {
            width: 100%;
            text-align: left;
        }
        #errorMessage.no-error {
            display: none;
        }
    </style>
    <template>
        <form id="movement-form"
                is="iron-form"
                ajax-method="[[_requestMethod(movement.id)]]"
                action="[[apiPath(movement.id)]]"
                on-iron-form-response="handleResponse" >
            <div id="errorMessage" class$="[[computedErrorMessageClass(errorMessage)]]">{{errorMessage}}</div>
            <input is="aitgud-generated-uuid" name="movement[id]" value$="[[movement.id]]"/>
            <input type="hidden" name="movement[amount]" value$="[[realAmount(movement.amount)]]" />
            <paper-input
                    name="movement[concept]"
                    label="Concept"
                    invalid="[[isInvalid(serverErrors.concept)]]"
                    error-message="[[serverErrors.concept]]"
                    value="[[movement.concept]]"
                    required >
            </paper-input>
            <paper-input-container
                    invalid="[[isInvalid(serverErrors.amount)]]"
                    required
                    value="movement.amount">
                <template is="dom-if" if="[[isExpending]]">
                    <div prefix>- </div>
                </template>
                <div suffix>â‚¬</div>
                <label>Amount</label>
                <input
                        is="iron-input"
                        type="number"
                        min="0"
                        step="0.01"
                        bind-value="{{uiAmount}}"
                        invalid="[[isInvalid(serverErrors.amount)]]">
                <paper-input-error>[[serverErrors.amount]]</paper-input-error>
            </paper-input-container>
            <paper-input
                    name="movement[date]"
                    label="Date"
                    type="date"
                    value="[[movement.date]]"
                    always-float-label
                    invalid="[[isInvalid(serverErrors.date)]]"
                    error-message="[[serverErrors.date]]"
                    required >
            </paper-input>
            <button type="submit">Create</button>
        </form>
    </template>

    <script>


        (function() {
            var defaultErrorMessage = 'There have been an error communicating to the server';
            var validationErrorMessage = 'Check the fields';
            var serverValidationErrorMessage = 'Validation Failed';

            function isServerError (request) {
                return request.request.xhr.readyState === 4 && request.request.xhr.response.message;
            }
            function isValidationError (request) {
                return request.request.xhr.response.message == serverValidationErrorMessage
            }

            Polymer({
                is: 'kontuak-form-new-movement',
                properties: {
                    uiAmount: {
                        type: String,
                        value: ''
                    },
                    isExpending: {
                        type: Boolean,
                        value: false
                    },
                    movement: {
                        type: Object,
                        value: {},
                        observer: 'movementUpdated'
                    },
                    serverErrors: {
                        type: Object,
                        value: {}
                    },
                    errorMessage: {
                        type: String,
                        value: ''
                    }
                },
                listeners: {
                    'movement-form.ironFormError': '_handleError'
                },
                handleResponse: function() {
                    page.redirect('/');
                },
                today: function() {
                    var a = new Date();
                    var month = a.getMonth() + 1;
                    var date = a.getDate();
                    return a.getFullYear() + '-' + (month < 10 ? '0' + month : month) + '-' + (date < 10 ? '0' + date : date);
                },
                realAmount: function(amount) {
                    var translatedAmount = '';
                    if (amount !== '') {
                        translatedAmount = Math.abs(amount);
                        if (this.isExpending) {
                            translatedAmount = -translatedAmount;
                        }
                    }
                    return translatedAmount;
                },
                movementUpdated: function() {
                    if (typeof this.movement.amount !== 'undefined') {
                        this.toggleAttribute('is-expending', this.movement.amount < 0);
                    }
                    this.set('uiAmount', Math.abs(this.movement.amount));
                },
                _handleError: function(error, request) {
                    var message;
                    debugger;
                    try  {
                        if (isServerError(request)) {
                            message = this._manageServerError(request);
                        } else {
                            message = request.error;
                        }
                    } catch (e) {
                        if (window.console) {
                            console.error(e)
                        }
                        message = defaultErrorMessage;
                    }
                    this.set('errorMessage', message);
                },
                isInvalid: function(error) {
                    return typeof error !== 'undefined' && error;
                },
                computedErrorMessageClass: function(message) {
                    if(message !== '') {
                        return '';
                    }
                    return 'no-error';
                },
                apiPath: function(id) {
                    var path = '/movements';
                    var host = 'http://127.0.0.1:8000';
                    if (id) {
                        path += '/' + id;
                    }
                    return host + path;
                },
                _requestMethod: function(id) {
                    var method = 'post';
                    if (id) {
                        method = 'put';
                    }
                    return method;
                },
                _manageServerValidationErrors: function(request) {
                    var errors = request.request.xhr.response.errors;
                    for (var childName in errors.children) {
                        if (errors.children[childName].errors) {
                            var childErrors = errors.children[childName].errors;
                            for (var errorMessage in childErrors) {
                                this.set('serverErrors.' + childName, childErrors[errorMessage]);
                            }
                        }
                    }
                },
                _manageServerError: function(request) {
                    if (isValidationError(request)) {
                        this._manageServerValidationErrors(request);
                        return validationErrorMessage;
                    } else {
                        return request.request.xhr.response.message;
                    }
                }
            });
        })();
    </script>
</dom-module>